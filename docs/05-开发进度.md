# 简家厨 - 开发进度记录

## 2026-02-15 开发进度

### 新增功能: 联网搜索菜谱

实现了三种搜索来源的智能切换:
1. **本地数据库** - 已有80+道菜谱
2. **天行数据API** - 联网扩展 (免费100次/天) ✅ 已配置
3. **MiniMax AI** - 智能菜谱推荐 ✅ 已配置

#### 新增文件

**后端:**
- `backend/src/adapters/search.adapter.ts` - 搜索适配器接口
- `backend/src/adapters/local.adapter.ts` - 本地数据库适配器
- `backend/src/adapters/tianxing.adapter.ts` - 天行数据API适配器
- `backend/src/adapters/ai.adapter.ts` - MiniMax AI适配器
- `backend/src/services/search.service.ts` - 统一搜索服务
- `backend/src/routes/search.routes.ts` - 搜索API路由

**前端:**
- `frontend/src/api/search.ts` - 搜索API封装
- `frontend/src/hooks/useSearch.ts` - 搜索Hook

#### 修改文件

- `backend/src/index.ts` - 注册搜索路由
- `backend/.env` - 添加API配置
- `frontend/src/types/index.ts` - 添加source字段
- `frontend/src/components/recipe/RecipeCard.tsx` - 显示来源标签
- `frontend/src/screens/recipe/RecipeListScreen.tsx` - 添加联网搜索按钮

#### 使用方式

1. 在菜谱列表页面，输入搜索词
2. 点击"联网搜索"按钮切换到联网模式
3. 搜索结果会显示来源标签: 本地/联网/AI推荐

---

## 2026-01-21 开发进度

### 已完成功能

#### 1. 菜谱管理模块
- ✅ 15个新菜谱数据入库
- ✅ 菜谱详情展示（大人版/宝宝版）
- ✅ 菜谱搜索功能
- ✅ 菜谱分类筛选

#### 2. 餐食计划模块
- ✅ 一周餐食计划展示
- ✅ 按日期设置餐食计划
- ✅ 餐食计划删除功能

#### 3. 购物清单模块
- ✅ 生成购物清单（基于餐食计划）
- ✅ 购物清单按区域分组显示（超市区/蔬果区/调料区/其他）
- ✅ 全选/取消全选功能
- ✅ 删除清单项功能
- ✅ 手动添加清单项功能
- ✅ 单个项目勾选功能

---

### 2026-01-21 修复问题

#### 问题1: 单个购物清单项无法勾选

**问题描述**：
- 点击单个购物清单项无法切换选中状态
- 只能通过"全选"按钮操作
- 前端有点击事件触发（黄色高亮），但UI不更新

**根本原因**：
后端 `updateListItem` 方法存在两个bug：

1. **JSON解析问题**：
   - 从数据库读取的 `list.items` 是JSON字符串
   - 代码直接类型转换未解析
   - 导致 `items[area]` 访问失败

2. **JSON序列化问题**：
   - 更新数据库时未使用 `JSON.stringify(items)`
   - 对象被存为 `"[object Object]"` 字符串
   - 后续读取导致JSON解析失败

**修复方案**：

```typescript
// 修复1: 解析items从JSON字符串到对象
const items = typeof list.items === 'string'
  ? JSON.parse(list.items)
  : list.items;

// 修复2: 序列化items为JSON字符串存储
.update({ items: JSON.stringify(items) })
```

---

#### 问题2: 获取购物清单API返回500错误

**问题描述**：
- 打开今日清单页面直接失败
- GET `/shopping-lists?start_date=2026-01-21` 返回500错误

**根本原因**：
- 数据库中存在corrupted数据 (`items: '[object Object]'`)
- `JSON.parse('[object Object]')` 抛出异常
- 未处理的异常导致API崩溃

**修复方案**：
在所有解析items的方法中添加try-catch错误处理：

```typescript
let parsedItems;
try {
  parsedItems = typeof list.items === 'string'
    ? JSON.parse(list.items)
    : list.items;
} catch (e) {
  console.error('[Backend] Failed to parse items for list:', list.id, e);
  parsedItems = {
    超市区: [],
    蔬果区: [],
    调料区: [],
    其他: [],
  };
}
```

**修复的方法** (共6个)：
1. `getShoppingLists` - 获取历史购物清单
2. `getShoppingListById` - 获取单个清单详情
3. `addRecipeToShoppingList` - 添加菜谱到清单
4. `removeListItem` - 删除清单项
5. `addListItem` - 手动添加清单项
6. `toggleAllItems` - 全选/取消全选

---

### 待修复问题

#### 1. 添加物品弹框自动关闭问题
**描述**：点击物品名称或数量的输入框时，弹框会自动关闭，无法输入
**优先级**：高
**相关文件**：`frontend/src/screens/plan/ShoppingListScreen.tsx`

#### 2. 删除按钮可能无法点击
**描述**：用户反馈删除功能可能无效
**优先级**：中

---

### 技术栈

**后端**：
- Node.js + Express
- SQLite + Knex.js
- TypeScript
- tsx watch (开发模式)

**前端**：
- React Native Web
- TanStack Query (React Query)
- Axios
- TypeScript

**开发工具**：
- Metro bundler (前端)
- tsx watch (后端)

---

### 开发信息

- 后端服务运行在端口 3000
- 前端开发服务器运行在端口 8085 (Web)
- 数据库文件位于 `backend/dev.sqlite3`
- 所有API路径以 `/api/v1` 开头

### 启动命令

```bash
# 后端
cd backend && npm run dev

# 前端 (Web)
cd frontend && npx expo start --web --port 8085
```
