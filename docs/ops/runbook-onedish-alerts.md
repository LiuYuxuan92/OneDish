# OneDish 值班 Runbook（告警处置）

## 1. 目的与适用范围
用于 OneDish 线上告警的标准化处置，覆盖：
- 5xx 错误率异常
- P95 延迟劣化
- 429（配额/限流）激增
- AI 预算水位超阈

目标：**5 分钟内止血，30 分钟内形成初步结论**。

---

## 2. 角色与职责
- **On-call（主值班）**：接警、定级、执行止血、同步状态
- **后端负责人**：定位服务与依赖问题，决定回滚/热修
- **产品/运营值守**：评估用户影响，执行对外口径（如需）

---

## 3. 告警分级
- **SEV1**：核心不可用 / 5xx 爆发 / 预算打满
- **SEV2**：延迟明显劣化 / 429 异常攀升
- **SEV3**：缓存命中率下降 / 上游轻微波动

---

## 4. 通用处置流程（所有告警）
1. **确认告警真实性**（是否误报、是否持续）
2. **快速定级**（SEV1/SEV2/SEV3）
3. **检查最近变更**（最近 30 分钟 deploy、配置、迁移）
4. **提取样本**（request_id、失败路由、受影响用户量）
5. **执行止血策略**（降级 / 限流调整 / 回滚）
6. **同步进展**（每 10 分钟更新一次）
7. **恢复后复盘**（30 分钟内提交事故小结）

---

## 5. 分场景 SOP

### 5.1 5xx 告警
**排查顺序**
- 应用日志中按 `request_id` 聚类看主错误类型
- 查看是否集中在特定 route/source
- 检查上游依赖（DB/缓存/第三方）错误率

**止血动作**
- 先切降级路径：`ai -> web -> cache -> local`
- 如由新版本引入：立即回滚到上一稳定版本
- 必要时启用临时熔断/限流保护

### 5.2 P95 延迟告警
**排查顺序**
- 区分 AI 与非 AI 路径
- 对慢路由看依赖耗时分布（DB、上游 API、队列）
- 关注是否由流量突增导致

**止血动作**
- AI 路径：降级为 cache/local，减少外部调用
- 非 AI 路径：临时关闭高成本功能或降低并发
- 必要时扩容（若基础设施支持）

### 5.3 429 告警
**排查顺序**
- 判断是 quota reject 还是 ratelimit reject 主导
- 检查是否配置变更导致阈值误伤
- 检查是否出现异常流量（攻击/爬虫/重试风暴）

**止血动作**
- 误配置：按审批临时上调阈值（记录变更）
- 异常流量：增加源头限流/黑名单策略
- 确保关键用户路径优先可用

### 5.4 预算水位告警
**排查顺序**
- 核对当日成本增长曲线与请求峰值
- 判断是否由 AI 路径异常重试导致
- 检查模型/参数是否变更

**止血动作**
- >=90%：执行流量降级，收敛 AI 调用
- >=100%：触发强制降级（仅 local/cache）
- 与产品确认当日策略（限功能/限人群）

---

## 6. 指挥与沟通模板

### 6.1 首次播报（IM）
```text
[OneDish][SEV2][进行中]
时间: 2026-xx-xx xx:xx UTC
告警: <alertname>
影响: <接口/用户范围>
现状: 已开始排查，初步怀疑 <原因>
动作: 已执行 <降级/回滚/限流>
下次更新: xx:xx UTC
```

### 6.2 恢复播报
```text
[OneDish][已恢复]
时间: 2026-xx-xx xx:xx UTC
恢复动作: <动作>
影响时长: <xx 分钟>
待办: 根因分析与修复计划将在 30 分钟内给出
```

---

## 7. 事故小结模板（30 分钟内）
- 事件编号：
- 发现时间 / 恢复时间：
- 影响面（请求量、用户数、关键路径）：
- 根因：
- 处置动作：
- 遗留风险：
- 预防改进（Owner + ETA）：

---

## 8. 演练与门禁
上线前必须完成：
- [ ] 5xx 告警演练
- [ ] P95 告警演练
- [ ] 429 告警演练
- [ ] 预算水位告警演练
- [ ] 告警通知链路验证
- [ ] 值班人员已确认本 Runbook

任一未完成：**No-Go**。
