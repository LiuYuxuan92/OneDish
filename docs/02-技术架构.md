# 简家厨 - 技术架构文档

## 技术栈概览

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 18+ | 运行环境 |
| TypeScript | 5.3+ | 开发语言 |
| Express | 4.18+ | Web 框架 |
| Knex.js | 3.1+ | 查询构建器 |
| SQLite3 | 5.1+ | 开发数据库 |
| PostgreSQL | - | 生产数据库 |
| JWT | 9.0+ | 认证 |
| bcryptjs | 2.4+ | 密码加密 |
| Winston | 3.11+ | 日志 |

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React Native | 0.73+ | 移动端框架 |
| TypeScript | 5.3+ | 开发语言 |
| React Navigation | 6.1+ | 路由导航 |
| React Query | 5.17+ | 数据请求 |
| Axios | 1.6+ | HTTP 客户端 |
| Styled Components | 6.1+ | 样式 |

---

## 项目结构

```
qinzicanhe/
├── docs/                              # 设计文档
├── backend/                           # 后端服务
│   ├── src/
│   │   ├── config/                   # 配置
│   │   ├── controllers/              # 控制器 (7个)
│   │   ├── services/                 # 服务层 (7个)
│   │   ├── routes/                   # 路由 (11个)
│   │   ├── middleware/               # 中间件
│   │   ├── types/                    # TypeScript 类型
│   │   ├── utils/                    # 工具函数
│   │   ├── database/                 # 数据库
│   │   │   ├── migrations/          # 迁移文件
│   │   │   └── seeds/               # 种子数据
│   │   └── index.ts                 # 入口文件
│   ├── .env
│   ├── knexfile.ts
│   └── package.json
│
└── frontend/                          # 前端应用
    ├── src/
    │   ├── api/                      # API 封装
    │   ├── components/               # 组件
    │   ├── hooks/                    # 自定义 Hooks
    │   ├── navigation/               # 导航配置
    │   ├── screens/                  # 页面组件
    │   ├── styles/                   # 样式
    │   ├── types/                    # TypeScript 类型
    │   └── App.tsx
    └── package.json
```

---

## 数据库设计

### 数据库选型

- **开发环境**: SQLite (无需额外安装，文件存储)
- **生产环境**: PostgreSQL (高性能，支持并发)

### 核心数据表

| 表名 | 说明 |
|------|------|
| users | 用户表 |
| ingredients | 食材表 |
| recipes | 菜谱表 |
| recipe_ingredients | 菜谱食材关联表 |
| favorites | 收藏表 |
| meal_plans | 餐食计划表 |
| shopping_lists | 购物清单表 |

### 数据表关系

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│    User     │────1:N─▶│  MealPlan   │─────────│   Recipe    │
│  (用户表)    │         │  (餐食计划)  │────N:1─▶│   (菜谱)    │
└─────────────┘         └─────────────┘         └─────────────┘
       │                                                 │
       │ N:1                                            │ 1:N
       ▼                                                ▼
┌─────────────┐                                 ┌─────────────┐
│  Favorite   │                                 │ Ingredient  │
│  (收藏表)    │                                 │  (食材表)    │
└─────────────┘                                 └─────────────┘
```

---

## API 设计

### 基础信息

```
开发环境: http://localhost:3000
基础路径: /api/v1
```

### 公开接口 (无需认证)

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/health` | 健康检查 |
| POST | `/auth/register` | 用户注册 |
| POST | `/auth/login` | 用户登录 |
| GET | `/recipes/daily` | 今日推荐 |
| GET | `/recipes/:id` | 菜谱详情 |
| GET | `/recipes` | 搜索菜谱 |
| GET | `/recipes/categories` | 获取分类 |
| GET | `/search` | 联网搜索菜谱 |
| GET | `/search/source/:source` | 指定来源搜索 |
| GET | `/ingredients` | 食材列表 |

### 认证接口 (需要 JWT Token)

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/auth/logout` | 退出登录 |
| POST | `/auth/refresh` | 刷新 Token |
| POST | `/favorites` | 添加收藏 |
| DELETE | `/favorites/:recipeId` | 取消收藏 |
| GET | `/favorites` | 收藏列表 |
| GET | `/meal-plans/weekly` | 一周计划 |
| POST | `/meal-plans` | 设置餐食计划 |
| DELETE | `/meal-plans/:planId` | 删除餐食计划 |
| POST | `/meal-plans/generate` | 生成一周计划 |
| POST | `/shopping-lists/generate` | 生成购物清单 |
| GET | `/shopping-lists` | 历史清单 |
| PUT | `/shopping-lists/:listId/items` | 更新清单项 |
| GET | `/users/me` | 用户信息 |
| PUT | `/users/me` | 更新用户信息 |

### 统一响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1234567890
}
```

### 错误码规范

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |

---

## 联网搜索功能

### 搜索架构

```
用户搜索请求
    │
    ▼
┌─────────────────────────────────────┐
│         搜索服务 (SearchService)       │
│  1. 先查本地数据库                   │
│  2. 本地无结果 → 查天行API           │
│  3. API无结果 → AI生成              │
└─────────────────────────────────────┘
```

### 搜索来源

| 来源 | 说明 | 配置 |
|------|------|------|
| local | 本地数据库 (80+菜谱) | 默认 |
| tianxing | 天行数据API (免费100次/天) | `TIANXING_API_KEY` |
| ai | MiniMax AI生成 | `MINIMAX_API_KEY` |

### 前端集成

在菜谱列表页面:
1. 输入搜索词
2. 点击"联网搜索"按钮
3. 显示结果来源标签 (本地/联网/AI推荐)

---

## 认证机制

### JWT Token

```
Header: {
  "alg": "HS256",
  "typ": "JWT"
}

Payload: {
  "user_id": "uuid",
  "username": "testuser",
  "exp": 1234567890
}
```

### Token过期时间
- Access Token: 24小时
- Refresh Token: 30天

---

## 前端架构

### 导航结构

```
RootNavigator
├── AuthNavigator (未登录)
│   ├── LoginScreen
│   └── RegisterScreen
└── MainNavigator (已登录)
    ├── HomeTab
    │   ├── HomeScreen
    │   ├── DailyRecommendationScreen
    │   └── RecipeDetailScreen
    ├── RecipeTab
    │   ├── RecipeListScreen
    │   ├── SearchScreen
    │   └── RecipeDetailScreen
    ├── PlanTab
    │   ├── WeeklyPlanScreen
    │   └── RecipeDetailScreen
    └── ProfileTab
        ├── ProfileScreen
        └── SettingsScreen
```

### 状态管理

使用 Redux + React Query：
- Redux: 管理全局状态（用户信息、UI状态）
- React Query: 管理API请求状态和缓存

---

## 环境配置

### 后端 (.env)

```env
NODE_ENV=development
PORT=3000
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=jianjiachu
JWT_SECRET=jianjiachu-secret-key-2025
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=30d
LOG_LEVEL=info
CORS_ORIGIN=*
```

### 前端 API 配置

```typescript
const BASE_URL = __DEV__
  ? 'http://localhost:3000/api/v1'
  : 'https://api.jianjiachu.com/v1';
```

---

## 部署

### 后端部署

```bash
# 1. 构建项目
npm run build

# 2. 使用 PM2 启动
pm2 start dist/index.js --name jianjiachu-backend
```

### 前端部署

```bash
# Android
cd android
./gradlew assembleRelease

# iOS (使用 Xcode)
# 在 Xcode 中打开项目，选择 Generic iOS Device
# Product -> Archive
```
