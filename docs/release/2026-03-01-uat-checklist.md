# OneDish 发布前总体验收（UAT）清单（可直接执行）

- 文档版本：v1.0
- 日期：2026-03-01
- 适用环境：staging（必须）/ 生产灰度（抽样复验）
- 验收目标：核心用户链路可用、协作权限正确、埋点可核验

---

## 0. 验收准备

### 0.1 账号与角色
- `UAT_OWNER`：共享创建者（owner）
- `UAT_MEMBER_A`：加入后成员（member）
- `UAT_MEMBER_B`：用于“移除成员/邀请码失效”验证

### 0.2 环境准备
- 客户端：至少 2 个设备/模拟器（或 2 个浏览器 profile）
- 后端：staging API 正常，数据库迁移已完成
- 观测：
  - API 日志（含 request_id）
  - `/metrics` 可抓取
  - `metrics_events` 表可查询

### 0.3 通过标准（总则）
- 所有 P0/P1 用例通过（见各用例“预期结果”）
- 失败用例必须有明确失败处理和复测结论

---

## 1) 首页推荐 / 一键换菜 / 推荐解释

## UAT-HOME-001：首页推荐加载
- 前置条件：
  - UAT_OWNER 已登录
  - 首页有可推荐菜品（推荐接口可返回至少 1 条）
- 操作步骤：
  1. 打开首页
  2. 等待推荐卡片渲染完成
  3. 记录当前推荐 recipe_id（如可见）
- 预期结果：
  - 页面无报错
  - 推荐卡片展示完整（标题、基础信息、操作按钮）
- 失败处理：
  - 截图 + 保存 request_id
  - 检查推荐接口返回（状态码/耗时/空数据）
  - 标记阻断：P1（首页核心内容不可用）

## UAT-HOME-002：一键换菜成功
- 前置条件：
  - 已完成 UAT-HOME-001
- 操作步骤：
  1. 点击“一键换菜”
  2. 观察推荐结果更新
- 预期结果：
  - 推荐卡片切换到新菜（与之前 recipe_id 不同或推荐内容变化）
  - 页面无白屏/卡死
- 失败处理：
  - 记录换菜前后 recipe_id
  - 检查接口状态码与超时
  - 若连续 2 次失败，升级为 P1

## UAT-HOME-003：推荐解释展示
- 前置条件：
  - 推荐卡片已展示
- 操作步骤：
  1. 点击“推荐解释”入口（或卡片解释区域）
  2. 查看解释文案
- 预期结果：
  - 能看到与用户上下文相关的推荐理由（非空、非占位文案）
- 失败处理：
  - 记录具体推荐项与解释文案
  - 若仅解释缺失但推荐可用，标记 P2；若导致崩溃，标记 P1

---

## 2) 购物清单生成与共享协作（owner/member/移除/邀请码失效）

## UAT-SL-001：生成购物清单
- 前置条件：
  - UAT_OWNER 在周计划或菜谱详情可触发“生成购物清单”
- 操作步骤：
  1. 触发“生成购物清单”
  2. 进入购物清单详情
- 预期结果：
  - 成功创建 list_id
  - 至少包含基础食材项
- 失败处理：
  - 记录 list_id 是否生成
  - 检查 `/shopping-lists` 相关接口

## UAT-SL-002：创建共享邀请（owner）
- 前置条件：
  - UAT_OWNER 有可共享购物清单
- 操作步骤：
  1. 在购物清单详情点击“创建共享链接/邀请码”
  2. 保存 invite_code
- 预期结果：
  - 返回 invite_code + share_link
  - 页面提示“共享链接已生成”
- 失败处理：
  - 记录错误码和提示文案
  - 阻断级别 P1（协作核心能力）

## UAT-SL-003：member 加入共享
- 前置条件：
  - 已拿到有效 invite_code
  - UAT_MEMBER_A 已登录
- 操作步骤：
  1. UAT_MEMBER_A 输入 invite_code 加入
  2. 打开共享购物清单
- 预期结果：
  - 加入成功，角色为 member
  - 可查看清单，允许执行成员权限内操作（如勾选）
- 失败处理：
  - 查询 share_member 记录是否写入
  - 若 owner 正常、member 无法加入，标记 P1

## UAT-SL-004：移除成员后权限失效
- 前置条件：
  - UAT_MEMBER_B 已加入共享清单
- 操作步骤：
  1. UAT_OWNER 在成员管理中移除 UAT_MEMBER_B
  2. UAT_MEMBER_B 刷新/重进清单
- 预期结果：
  - 被移除成员访问被拒绝（无权限）
- 失败处理：
  - 检查移除接口返回与成员关系表
  - 若移除后仍可访问，标记 P0（权限漏洞）

## UAT-SL-005：邀请码失效验证（重置邀请码）
- 前置条件：
  - 已有旧邀请码 old_invite_code
- 操作步骤：
  1. UAT_OWNER 执行“重置邀请码”
  2. 使用 old_invite_code 尝试加入（UAT_MEMBER_B）
  3. 使用新 invite_code 再尝试加入
- 预期结果：
  - 旧邀请码加入失败
  - 新邀请码加入成功
- 失败处理：
  - 查询 `share_invite_revocations` 是否写入旧码
  - 若旧码仍可用，标记 P0

---

## 3) 周计划共享协作（加入/查看/标记完成）

## UAT-MP-001：周计划创建共享邀请
- 前置条件：
  - UAT_OWNER 拥有周计划
- 操作步骤：
  1. 进入周计划页面
  2. 创建共享邀请，保存 invite_code
- 预期结果：
  - 成功返回 invite_code + share_link
- 失败处理：
  - 记录接口失败信息

## UAT-MP-002：成员加入并查看
- 前置条件：
  - UAT_MEMBER_A 未加入该周计划
- 操作步骤：
  1. UAT_MEMBER_A 输入 invite_code
  2. 加入后查看共享周计划明细
- 预期结果：
  - 加入成功
  - 可查看计划内容（天/餐次/菜品）
- 失败处理：
  - 查 join 接口与 share member 关系

## UAT-MP-003：标记完成同步
- 前置条件：
  - UAT_MEMBER_A 能查看周计划
- 操作步骤：
  1. UAT_MEMBER_A 将某餐次标记完成
  2. UAT_OWNER 刷新查看同一餐次状态
- 预期结果：
  - 状态同步一致
  - 时间戳/完成状态更新正确
- 失败处理：
  - 核对 meal plan 状态更新接口与数据库状态
  - 若协作状态不同步，标记 P1

---

## 4) 埋点关键事件核验（含 swap_success）

## UAT-METRICS-001：swap_success 上报核验
- 前置条件：
  - 可访问首页并执行换菜
- 操作步骤：
  1. 执行一次“一键换菜”成功
  2. 查询 `metrics_events` 表中最近事件
- 预期结果：
  - 存在 `event_name='swap_success'` 事件
  - 事件时间与操作时间匹配（误差 < 2 分钟）
  - payload 含 page_id/page_url/session_id 等关键字段
- 失败处理：
  - 校验前端 `trackEvent/trackMainFlowEvent` 触发点
  - 校验后端事件白名单（若未放行需补录 issue）

## UAT-METRICS-002：共享事件上报核验
- 前置条件：
  - 已执行共享重置邀请码与成员移除
- 操作步骤：
  1. 执行“重置邀请码”
  2. 执行“移除成员”
  3. 查询最近事件
- 预期结果：
  - 存在 `share_invite_regenerated`
  - 存在 `share_member_removed`
  - 事件平台字段合法（web/h5）
- 失败处理：
  - 检查 /metrics/events 返回码
  - 若业务成功但埋点缺失，标记 P2（可灰度，需发布后补齐）

## UAT-METRICS-003：推荐质量指标字段可用性（avg_quality_score）
- 前置条件：
  - 数据库中有 user_recipes 数据
- 操作步骤：
  1. 执行 SQL 抽样：`SELECT AVG(quality_score) FROM user_recipes WHERE status='published';`
  2. 与监控面板口径对齐检查（同时间窗口）
- 预期结果：
  - 能稳定产出 `avg_quality_score`
  - 与看板口径一致（误差可解释）
- 失败处理：
  - 确认 SQL 与看板时间窗口/过滤条件
  - 标记数据口径问题，发布后 24h 内修复

---

## 5) UAT 结果记录模板

| 用例ID | 执行人 | 结果(通过/失败) | 证据（截图/日志/request_id） | 备注 |
|---|---|---|---|---|
| UAT-HOME-001 |  |  |  |  |
| UAT-HOME-002 |  |  |  |  |
| UAT-HOME-003 |  |  |  |  |
| UAT-SL-001 ~ 005 |  |  |  |  |
| UAT-MP-001 ~ 003 |  |  |  |  |
| UAT-METRICS-001 ~ 003 |  |  |  |  |

---

## 6) 发布闸门建议（UAT）
- 可提交：P0=0，P1=0，P2 <= 2（且有明确修复计划）
- 不可提交：存在任一 P0 或 P1 未关闭
