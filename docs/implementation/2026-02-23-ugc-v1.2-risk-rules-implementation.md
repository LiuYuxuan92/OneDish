# UGC V1.2 风险词白名单 + 分月龄规则增强实现说明（2026-02-23）

## 1. 实现概览

本次实现按“文档先行 -> 实现 -> 测试 -> 报告”执行，聚焦最小可用能力：

- 后端新增可配置风险引擎（黑名单 + 白名单 + 月龄门控）
- 审核链路区分 `block` 与 `warn`
- API 返回 `risk_hits`，并在拦截时返回结构化错误
- 前端投稿页展示提审反馈：命中词 + 风险原因 + 建议替代

## 2. 后端改动

## 2.1 新增风险规则服务

文件：`backend/src/services/ugc-risk.service.ts`

- `UgcRiskService.evaluate(recipe)` 返回：
  - `riskHits: RiskHit[]`
  - `safeForSubmit: boolean`
- 支持字段：`key/level/keyword/reason/suggestion`
- 支持白名单例外词（当前示例：`蜂蜜色`）
- 支持基础月龄解析：`8-12个月`、`<12m`

## 2.2 提审/审核链路接入

文件：`backend/src/services/userRecipe.service.ts`

- 新增 `SafetyValidationError`（携带 `riskHits`）
- `submitForReview`：仅 `block` 命中时阻断
- `reviewRecipe(published)`：仅 `block` 命中时阻断
- `parseRecipe` 输出增加 `risk_hits`
- 兼容性：保留既有响应主结构和数据字段

## 2.3 控制器错误返回增强

文件：`backend/src/controllers/userRecipe.controller.ts`

- 捕获 `SafetyValidationError`，返回：
  - `validation_errors`
  - `risk_hits`

## 3. 前端改动

## 3.1 API 类型扩展

文件：`frontend/src/api/userRecipes.ts`

- 新增 `RiskHit` 类型
- `UserRecipe` 增加 `risk_hits?: RiskHit[]`

## 3.2 投稿页反馈增强

文件：`frontend/src/screens/profile/MyRecipesScreen.tsx`

- 提交成功但存在 `warn`：弹窗提示可继续提交
- 提交失败（`block`）：弹窗展示具体命中项与替代建议
- 列表卡片新增“提审反馈”区域，展示 `risk_hits`

## 4. 体验路径

1. 进入「我的投稿」页创建/编辑草稿
2. 输入可能风险词并保存
3. 点击“提交审核”
   - 若仅 `warn`：可提交并显示提醒
   - 若命中 `block`：阻断并展示原因 + 建议替代
4. 在卡片“提审反馈”查看命中详情

## 5. 已知边界（MVP）

- 月龄解析目前是基础解析（覆盖主流输入）
- 白名单暂为规则内静态配置，后续可外置到配置中心
- 前端 warn 提示基于当前数据快照，后续可加“提交前实时校验 API”
