# OneDish 告警配置最小清单（上线前）

## 目标
建立最小可用的线上告警门禁，覆盖可用性、性能、配额与成本风险。

## A. 必配告警（P0）

### 1) 服务错误率（5xx）
- 指标：`onedish_http_requests_total{status=~"5.."}`
- 规则：
  - 5 分钟窗口内 5xx 占比 > 2% 持续 5 分钟 -> 告警
  - 5xx 占比 > 5% 持续 2 分钟 -> 紧急告警
- 动作：
  - 通知 on-call
  - 自动附带 request_id 样本与最近 deploy 版本

### 2) 延迟（P95）
- 指标：`onedish_http_request_duration_ms`
- 规则：
  - 非 AI 路径 P95 > 800ms 持续 10 分钟 -> 告警
  - AI 路径 P95 > 6000ms 持续 10 分钟 -> 告警

### 3) 配额超限（429）
- 指标：`onedish_quota_reject_total`, `onedish_ratelimit_reject_total`
- 规则：
  - 10 分钟内 429 数量 > 100 或环比增长 > 200% -> 告警
- 动作：
  - 检查是否误配置限额
  - 评估是否触发降级策略

### 4) 预算水位（成本）
- 指标：`onedish_ai_cost_usd_total`
- 规则：
  - 日预算使用 >= 70% -> 预警
  - 日预算使用 >= 90% -> 告警
  - 日预算使用 >= 100% -> 紧急告警 + 自动降级 AI 路径

---

## B. 推荐告警（P1）

### 5) 缓存命中率
- 指标：`onedish_cache_hit_total` / (`hit+miss`)
- 规则：命中率 < 40% 持续 30 分钟 -> 优化告警

### 6) 上游可用性
- 指标：`onedish_upstream_requests_total`, `onedish_upstream_latency_ms`
- 规则：上游错误率 > 10% 或超时率 > 5% 持续 10 分钟 -> 告警

---

## C. 告警路由与值班

- 严重级别：
  - SEV1：5xx 爆发、预算打满、核心接口不可用
  - SEV2：延迟劣化、429异常攀升
  - SEV3：缓存命中率下降、上游轻微波动

- 通知渠道：
  - SEV1：电话/IM 强提醒
  - SEV2：IM + 邮件
  - SEV3：日报汇总

---

## D. 上线门禁（Go/No-Go）

上线前必须满足：
- [ ] 5xx 告警规则已上线并演练
- [ ] P95 告警规则已上线并演练
- [ ] 429 告警规则已上线并演练
- [ ] 预算水位告警已上线并演练
- [ ] 告警通知链路验证通过（至少一次）
- [ ] 值班联系人与 Runbook 已确认

未满足任一项：**No-Go**。

---

## E. 值班 Runbook（最小动作）

1. 先判定告警级别（SEV1/2/3）
2. 查看 `request_id` 样本 + 最近部署变更
3. 若为 AI/上游问题：立即降级到 local/cache
4. 若为配额误伤：临时上调阈值并记录审批
5. 30 分钟内产出事故小结（影响面、根因、修复）
