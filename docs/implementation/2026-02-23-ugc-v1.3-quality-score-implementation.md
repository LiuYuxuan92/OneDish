# UGC V1.3 质量评分与推荐入池 实现说明

日期：2026-02-23

## 1. 本次实现概览

按“最小可用”完成：
- 后端新增 `quality_score` 规则打分与 `in_recommend_pool` 入池标记
- 推荐流程支持“官方 + 高质量UGC混排”（开关可控）
- 增加管理接口：重算评分、查看入池清单
- 前端投稿/广场页展示质量标签（推荐入池 / 待优化）

## 2. 后端改动

### 2.1 数据库字段
新增 migration：
- `backend/src/database/migrations/20260223012001_add_ugc_quality_score_fields.ts`

新增字段：
- `quality_score` (int, default 0)
- `in_recommend_pool` (bool, default false)
- `report_count` (int, default 0)
- `adoption_rate` (float, default 0)

### 2.2 质量评分逻辑
修改：`backend/src/services/userRecipe.service.ts`

新增：
- `calculateQualityScore(raw)`：四维打分（完整度/安全性/可执行性/反馈表现）
- `shouldEnterRecommendPool(raw, score)`：阈值+剔除规则判定
- `computeQualityFields(raw)`：输出 `{ quality_score, in_recommend_pool }`

接入时机：
- 草稿创建/更新
- 提交审核
- 审核通过/驳回
- 提供批量重算能力

### 2.3 管理接口
修改：
- `backend/src/controllers/userRecipe.controller.ts`
- `backend/src/routes/userRecipe.routes.ts`

新增接口：
- `POST /api/v1/user-recipes/admin/recompute-quality`（admin）
- `GET /api/v1/user-recipes/admin/recommend-pool`（admin）

### 2.4 推荐混排
修改：`backend/src/services/recipe.service.ts`

在 `getDailyRecommendation` 中新增：
- 开关 `RECOMMEND_MIX_UGC_ENABLED`（`false` 关闭）
- 开启时按概率（30%）尝试从 `user_recipes` 入池内容抽取，否则回退官方 recipes

## 3. 前端改动

修改：
- `frontend/src/api/userRecipes.ts`（新增 `quality_score`、`in_recommend_pool` 类型）
- `frontend/src/screens/profile/MyRecipesScreen.tsx`

新增展示：
- 质量标签组件 `QualityTag`
- 在“我的投稿/发布广场”卡片展示：
  - 推荐入池（绿色）
  - 待优化（灰色）
  - 附加分数

## 4. 设计取舍

- 先用规则打分，便于上线与校准
- 反馈表现字段先由后台维护（report/adoption），后续可接入真实行为流水
- 混排先做单条推荐概率混排，后续再扩展到列表级排序模型

## 5. 对标差异（下厨房）

本实现有意提升“可执行 + 宝宝安全”影响力：
- 安全性权重高，命中 block 直接剔除
- 可执行性独立打分，强调步骤分叉与家庭一锅出可落地
- 反馈表现权重较低，避免纯互动驱动挤压安全价值
