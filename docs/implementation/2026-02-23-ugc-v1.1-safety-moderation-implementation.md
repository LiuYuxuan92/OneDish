# UGC V1.1 安全与审核增强实现说明（2026-02-23）

## 本次实现概览

已完成“文档先行 + 实现 + 测试 + 报告”闭环，聚焦最小可用版本：

1. 审核权限隔离（review 仅 admin 可调用）
2. 投稿内容安全校验（高风险词阻断发布/提审）
3. UGC 结构化字段补强（含 migration）
4. 兼容已有 UGC 数据（默认值兜底）
5. 前端最小字段输入 + 状态/失败原因展示 + 非管理员不显示审核通过

---

## 后端改动

### 1) 审核权限隔离

- 文件：`backend/src/controllers/userRecipe.controller.ts`
- 变更：`review` 接口增加 role 校验。
- 行为：`req.user.role !== 'admin'` 时返回 `403 / 仅管理员可审核`。

### 2) 内容安全校验（高风险规则）

- 文件：`backend/src/services/userRecipe.service.ts`
- 新增：`validateSafety(recipe)`
- 命中规则：
  - 蜂蜜
  - 整颗/整粒坚果
  - 酒精相关（白酒/啤酒/料酒/黄酒/葡萄酒）
  - 高盐高糖（高盐/重盐/高糖/重糖/加糖/盐焗）
- 生效点：
  - `submitForReview`：命中则阻断提交并返回原因
  - `reviewRecipe(action=published)`：发布前再次兜底校验

### 3) 结构化字段补强 + migration

- 新 migration：
  - `backend/src/database/migrations/20260223000101_add_role_and_ugc_structured_fields.ts`
- 新增字段：
  - `users.role`（默认 user）
  - `user_recipes.baby_age_range`
  - `user_recipes.allergens`
  - `user_recipes.is_one_pot`
  - `user_recipes.step_branches`
- `normalizePayload`/`parseRecipe` 已支持上述字段序列化与默认值。

### 4) 兼容已有数据

- `parseRecipe` 对旧数据增加默认值：
  - `allergens: []`
  - `step_branches: []`
  - `baby_age_range: null`
  - `is_one_pot: null`

### 5) 认证 payload 增强

- 文件：
  - `backend/src/types/index.ts`
  - `backend/src/services/auth.service.ts`
  - `backend/src/controllers/auth.controller.ts`
  - `backend/src/controllers/user.controller.ts`
- 变更：JWT payload 和用户信息输出包含 `role`。

---

## 前端改动

### 1) 投稿表单结构化字段（最小版）

- 文件：`frontend/src/screens/profile/MyRecipesScreen.tsx`
- 新增输入：
  - 月龄范围
  - 过敏原
  - 是否一锅出
  - 步骤分叉备注

### 2) 审核状态与失败原因反馈

- 提交审核失败时弹窗展示后端返回原因（如风险词命中）。
- 卡片中展示 `status` 与 `reject_reason`。

### 3) 管理员操作可见性

- 基于 `useUserInfo()` 的 `role` 判断。
- 非管理员不显示“审核通过”按钮。

### 4) API/Hook 补强

- 文件：
  - `frontend/src/api/userRecipes.ts`（结构化字段类型）
  - `frontend/src/api/users.ts`（role）
  - `frontend/src/hooks/useUserRecipes.ts`（新增 `useReviewUserRecipe`）

---

## 风险与回滚（实现层）

1. 误拦截风险：当前词表策略高召回，后续可精细化。
2. 权限风险：依赖 token role，若无 role 默认 user（更安全）。
3. 回滚方式：
   - 代码回滚至前一版本
   - 执行 migration down 回退新增列