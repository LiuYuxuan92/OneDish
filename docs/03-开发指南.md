# 简家厨 - 开发指南

## 快速开始

### 环境要求

- Node.js 18+
- npm 或 yarn
- Git

### 后端启动

```bash
# 1. 进入后端目录
cd backend

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp .env.example .env

# 4. 运行数据库迁移
npm run migrate

# 5. 导入种子数据
npm run seed

# 6. 启动开发服务器
npm run dev
```

后端服务将运行在 `http://localhost:3000`

### API Key 配置

联网搜索功能需要配置以下环境变量 (已在 .env 中配置):

```env
# 天行数据API (可选，免费100次/天)
# 申请地址: https://www.tianapi.com/
TIANXING_API_KEY=0dfec918832662d75de81472804ee227

# MiniMax AI API (必填)
MINIMAX_API_KEY=sk-cp-xxx
MINIMAX_BASE_URL=https://api.minimax.chat/v1
MINIMAX_MODEL=abab6.5s-chat
```

### 前端启动

```bash
# 1. 进入前端目录
cd frontend

# 2. 安装依赖
npm install

# 3. 启动 Metro bundler
npm start

# 4. 运行 Android
npm run android

# 或运行 iOS (仅 macOS)
npm run ios
```

---

## 数据库操作

```bash
# 运行迁移
npm run migrate

# 回滚最后一次迁移
npm run migrate:rollback

# 导入种子数据
npm run seed

# 重置数据库 (删除所有数据)
rm backend/dev.sqlite3
npm run migrate
npm run seed
```

---

## API 请求示例

```bash
# 健康检查
curl http://localhost:3000/health

# 用户登录
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'

# 获取今日推荐
curl http://localhost:3000/api/v1/recipes/daily

# 联网搜索菜谱 (自动切换来源)
curl "http://localhost:3000/api/v1/search?keyword=番茄"

# 指定来源搜索
curl "http://localhost:3000/api/v1/search/source/tianxing?keyword=鸡蛋"
```

---

## 开发规范

### 代码规范

- 使用 TypeScript 编写
- 遵循 ESLint 规则
- 使用 Prettier 格式化代码
- 变量命名：小驼峰 `camelCase`
- 常量命名：大写下划线 `UPPER_SNAKE_CASE`
- 组件命名：大驼峰 `PascalCase`

### Git 提交规范

```
<type>(<scope>): <subject>

feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 重构代码
test: 测试相关
chore: 构建过程或辅助工具变动
```

### API 开发规范

1. 使用 RESTful 风格
2. 统一响应格式
3. 使用适当的 HTTP 状态码
4. 添加错误处理和日志记录

---

## 常见问题

### 后端问题

**Q: 数据库连接失败**
```
A: 检查 .env 配置，确保数据库服务运行中
   开发环境使用 SQLite，自动创建 dev.sqlite3 文件
```

**Q: 迁移失败**
```
A: 删除 dev.sqlite3 文件，重新运行 migrate 和 seed
```

**Q: 端口被占用**
```
A: 修改 .env 中的 PORT 配置
   或运行: netstat -ano | findstr :3000
```

### 前端问题

**Q: Metro bundler 启动失败**
```
A: 清除缓存: npm start -- --reset-cache
   删除 node_modules: rm -rf node_modules && npm install
```

**Q: Android 构建失败**
```
A: 检查 Android SDK 和 JDK 版本
   确保 ANDROID_HOME 环境变量配置正确
   运行: cd android && ./gradlew clean
```

**Q: 无法连接到后端 API**
```
A: 确认后端服务已启动 (http://localhost:3000)
   检查 src/api/client.ts 中的 BASE_URL 配置
   确保模拟器可以访问 localhost (Android 使用 10.0.2.2)
```

**Q: "No apps connected" 警告**
```
A: 这是正常的，说明 Metro bundler 已启动但还没有应用连接
   运行 npm run android 或 npm run ios 来连接应用
```

---

## 测试规范化（Smoke + 文档）

### 一键运行 Smoke
在项目根目录执行：

```bash
bash scripts/test/smoke.sh
```

脚本会自动完成：
1. 检查 backend（3000）和 frontend（8081）可达性
2. 执行 5 项核心 API 冒烟：
   - `POST /api/v1/auth/guest`
   - `GET /api/v1/recipes/daily`
   - `GET /api/v1/recipes/:id`
   - `GET /api/v1/meal-plans/weekly`
   - `GET /api/v1/shopping-lists`
3. 输出每项通过/失败结果与汇总统计
4. 失败时返回非 0 退出码（可用于 CI 门禁）

可选环境变量：

```bash
BACKEND_URL=http://localhost:3000 \
FRONTEND_URL=http://localhost:8081 \
API_BASE=http://localhost:3000/api/v1 \
bash scripts/test/smoke.sh
```

### 如何编写测试文档
- 页面回归测试计划模板：
  `docs/testing/templates/page-regression-test-plan-template.md`
- 页面回归测试报告模板：
  `docs/testing/templates/page-regression-test-report-template.md`

建议流程：
1. 复制计划模板到 `docs/testing/plans/` 并补齐范围/用例/通过标准
2. 执行测试后，复制报告模板到 `docs/testing/reports/` 填写结果与缺陷
3. 报告中附关键截图、日志和失败请求信息，确保可追溯

---

## 项目状态

### 已完成

| 模块 | 状态 |
|------|------|
| 后端项目结构 | ✅ |
| 数据库设计 | ✅ |
| 数据库迁移 | ✅ |
| 种子数据 | ✅ |
| API 控制器 | ✅ |
| 服务层 | ✅ |
| 认证中间件 | ✅ |
| 前端项目结构 | ✅ |
| 导航配置 | ✅ |
| 主题样式 | ✅ |
| 页面组件 | ✅ |
| 15个新菜谱数据入库 | ✅ |
| 菜谱搜索功能 | ✅ |
| 一周餐食计划 | ✅ |
| 购物清单生成 | ✅ |
| 联网搜索菜谱 (本地/天行API/AI) | ✅ |

### 待完成

| 功能 | 优先级 |
|------|--------|
| 完善用户认证流程 | P0 |
| 图片上传 | P1 |
| 推送通知 | P1 |
| 营养分析 | P2 |
