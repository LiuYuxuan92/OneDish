# UGC V1.1 安全与审核增强计划（2026-02-23）

## 1. 背景与目标

在 UGC V1 已支持草稿/提审/发布状态流转基础上，V1.1 聚焦“安全与审核增强”，目标：

1. 审核权限隔离：普通用户不能直接执行审核通过/驳回。
2. 宝宝喂养高风险规则：在投稿内容中识别并拦截明显高风险内容。
3. 投稿结构化字段：补强月龄范围、过敏原、一锅出、步骤分叉等字段，支持后续精细化审核与推荐。
4. 风险可控：提供兼容与回滚方案，避免影响现有 UGC 数据和主链路。

---

## 2. 范围（Scope）

### 2.1 后端

- review 接口增加 admin role 校验。
- submit/review 发布链路增加内容安全校验（命中高风险词阻断并返回原因）。
- user_recipes 表新增结构化字段（migration）。
- 兼容旧数据读取与写入。

### 2.2 前端

- 投稿表单新增最小结构化输入：
  - 月龄范围（文本）
  - 过敏原（多项文本）
  - 是否一锅出（布尔）
  - 步骤分叉（文本）
- 提交审核后显示状态与失败原因。
- 非管理员不展示“审核通过”操作。

### 2.3 文档与测试

- 测试计划、实现文档、测试报告完整闭环。
- 覆盖构建、类型检查、smoke、专项验证（>=5）。

---

## 3. 设计方案

## 3.1 审核权限隔离

- JWT payload 增加 `role`（`user` | `admin`），默认 `user`。
- users 表增加 role 列，默认 `user`。
- review 接口：仅当 `req.user.role === 'admin'` 才允许审核。
- 非 admin 访问 review 返回 403（权限不足）。

## 3.2 宝宝喂养高风险规则（首版词表规则）

### 规则触发词（首版）

- 蜂蜜：蜂蜜
- 整颗坚果：整颗坚果、整粒坚果、整颗花生、整粒花生
- 酒精：酒精、白酒、啤酒、料酒、黄酒、葡萄酒
- 高盐高糖：高盐、重盐、高糖、重糖、加糖、盐焗

### 拦截策略

- 校验范围：投稿名称、成人/宝宝食材、步骤、烹饪提示、标签。
- 命中后：阻止提交审核/发布，返回 `validation_errors`（可读原因）。
- 说明：V1.1 采用“高召回优先”的词表策略，后续迭代引入上下文与月龄判定。

## 3.3 投稿结构化字段

新增字段（user_recipes）：

- `baby_age_range` string，可空（示例：`8-12个月`）
- `allergens` json，可空（示例：`["蛋","奶"]`）
- `is_one_pot` boolean，可空
- `step_branches` json，可空（示例：`[{"for":"baby","from_step":3,"note":"改为蒸煮"}]`）

兼容策略：

- 读取时默认值：`baby_age_range: null`、`allergens: []`、`is_one_pot: null`、`step_branches: []`。
- 不破坏旧字段；旧数据无需回填即可正常展示与提交。

---

## 4. 风险与回滚

## 4.1 风险

1. 误拦截：词表过宽导致正常内容被拒。
2. 权限误配：管理员 token 未带 role 导致审核不可用。
3. 兼容风险：旧数据无结构化字段，前端渲染异常。
4. migration 风险：新增列后历史代码路径读取异常。

## 4.2 缓解

- 后端返回明确失败原因，便于用户改稿。
- 保持字段全可空并提供解析默认值。
- review 权限仅新增“收紧”，不影响普通投稿。
- 提供回滚 migration（drop 新增列 / role 列）。

## 4.3 回滚方案

1. 回滚代码到上一个稳定 commit。
2. 执行 knex migration down 回退新增 schema。
3. 若仅规则问题，可热修词表（降低拦截范围）。

---

## 5. 交付物

- 代码：后端权限+安全校验+数据结构增强，前端表单与状态展示增强。
- 文档：计划、测试计划、实现说明、测试报告。
- 验证：backend build、frontend type-check、smoke、专项验证 >=5。