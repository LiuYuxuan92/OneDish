# 反馈驱动推荐排序 V2 方案（2026-02-22）

## 1. 目标

在不破坏现有推荐接口与交互流程的前提下，为智能推荐增加“反馈驱动重排”能力：
- 利用近 7 天反馈数据提升排序质量；
- 按餐次隔离学习（breakfast/lunch/dinner 分开计算）；
- 权重可配置（时间、库存、宝宝适配、反馈）；
- 返回 explain 与 vs_last，提升可解释性与可感知变化。

## 2. 范围与非目标

### 本期范围（MVP）
1. 后端推荐打分升级为 V2（在原 V1 基础上叠加反馈权重）。
2. 推荐结果项新增字段：
   - `explain: string[]`（为什么推荐）
   - `vs_last: string`（与上次推荐差异摘要，简版）
3. 前端推荐弹窗展示上述两个字段。
4. 完成构建、类型检查、smoke 与专项验证。

### 非目标
- 不引入在线模型训练；
- 不修改反馈表结构；
- 不做复杂多目标优化器（维持可维护的启发式排序）。

## 3. 排序输入定义

### 3.1 近 7 天采纳率（反馈输入）
- 数据源：`recommendation_feedbacks`
- 口径：按用户 + 餐次（meal_type）统计近 7 天：
  - `total`
  - `accepted`（A/B）
  - `adoption_rate = accepted / total`
- 用法：作为该餐次的反馈正向系数，提升排序稳定性。

### 3.2 拒绝原因（反馈输入）
- 数据源：`recommendation_feedbacks.reject_reason`
- 口径：按用户 + 餐次 + 近 7 天聚合关键模式（MVP 关键词匹配）：
  - 时间压力类：`耗时/时间/来不及/太久`
  - 食材不足类：`没食材/缺食材/库存/买菜`
  - 宝宝不适配类：`宝宝/不适合孩子/太辣/刺激`
- 用法：当出现相关高频拒绝时，分别强化对应维度（时间、库存、宝宝）的惩罚或奖励。

### 3.3 餐次隔离学习
- breakfast/lunch/dinner 独立统计、独立应用权重增益。
- `all-day` 请求在内部按三个餐次分别重排，不共享反馈统计。

## 4. V2 打分模型（可配置）

`score_v2 = w_time * S_time + w_inventory * S_inventory + w_baby * S_baby + w_feedback * S_feedback`

默认权重（可通过环境变量覆盖）：
- `w_time=0.30`
- `w_inventory=0.25`
- `w_baby=0.20`
- `w_feedback=0.25`

说明：
- `S_time`：准备时长越短分越高。
- `S_inventory`：缺口食材越少分越高。
- `S_baby`：宝宝适配为高分，不适配低分。
- `S_feedback`：由近 7 天采纳率 + 拒绝原因模式构成。

环境变量（可选）：
- `REC_RANK_V2_WEIGHT_TIME`
- `REC_RANK_V2_WEIGHT_INVENTORY`
- `REC_RANK_V2_WEIGHT_BABY`
- `REC_RANK_V2_WEIGHT_FEEDBACK`

## 5. explain 字段定义

`explain: string[]`，每条为可读原因，最多 3~4 条，示例：
- `近期同餐次采纳率高`
- `准备时间更短`
- `库存覆盖更好，缺口食材更少`
- `宝宝月龄适配更好`
- `近期该餐次反馈更偏好快手方案`

规则：
- 至少返回 1 条；
- 由高贡献维度生成；
- 文案稳定、可测试。

## 6. vs_last 字段定义

`vs_last: string`，描述与“同用户同餐次上次推荐”差异，简版：
- 首次：`首次推荐，暂无历史对比`
- 非首次（示例）：
  - `相较上次，主推荐由「番茄炒蛋」调整为「虾仁蒸蛋」；预计耗时 -5 分钟`
  - `相较上次，库存缺口更少（-2）`

实现策略（MVP）：
- 在服务进程内存保留最近一次推荐快照（按 user_id + meal_type）；
- 当前请求完成后写入快照；
- 不影响现有 API 结构，仅在 item 上附加字段。

## 7. 兼容性与回滚

- 兼容：原字段保留，新字段为增量输出；旧前端忽略不影响。
- 回滚：
  1) 将 `w_feedback` 配置为 0，即退化到近似 V1；
  2) 前端可隐藏 explain/vs_last 展示。

## 8. 验收标准

1. 推荐结果可见 `explain` 与 `vs_last`。
2. 同一用户不同餐次反馈互不污染。
3. 近 7 天采纳率与拒绝原因可实质影响排序。
4. 权重可通过环境变量调整并生效。
5. 构建与基础 smoke 不回归。